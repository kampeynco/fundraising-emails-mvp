{
  "version": 3,
  "sources": ["../../../../../../trigger/schedule-email-deliveries.ts"],
  "sourcesContent": ["import { task, logger, metadata, AbortTaskRunError } from \"@trigger.dev/sdk\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst supabase = createClient(\n    process.env.SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\n// Day name â†’ JS getDay() index\nconst DAY_INDEX: Record<string, number> = {\n    sunday: 0, monday: 1, tuesday: 2, wednesday: 3,\n    thursday: 4, friday: 5, saturday: 6,\n};\n\n/**\n * Get the next N upcoming delivery dates from today, given a set of delivery days.\n *\n * Example: today is Friday, delivery_days = ['monday', 'wednesday']\n *   â†’ [next Monday, next Wednesday, Monday after that, ...]\n *\n * If today IS a delivery day and it's before the send time, today is included.\n * Otherwise, we skip to the next occurrence.\n */\nfunction getNextDeliveryDates(\n    deliveryDays: string[],\n    count: number,\n    sendHour: number,\n    timezone: string\n): Date[] {\n    const dates: Date[] = [];\n    const now = new Date();\n\n    // Get the target day indices sorted\n    const targetDays = deliveryDays\n        .map(d => DAY_INDEX[d.toLowerCase()])\n        .filter(d => d !== undefined)\n        .sort((a, b) => a - b);\n\n    if (targetDays.length === 0) return [];\n\n    // Start scanning from today\n    let scanDate = new Date(now);\n\n    while (dates.length < count) {\n        const dayOfWeek = scanDate.getDay();\n\n        if (targetDays.includes(dayOfWeek)) {\n            // Build the delivery timestamp at sendHour in the user's timezone\n            const deliveryDate = new Date(scanDate);\n            deliveryDate.setHours(sendHour, 0, 0, 0);\n\n            // Only include if it's in the future (at least 1 hour from now)\n            const oneHourFromNow = new Date(now.getTime() + 60 * 60 * 1000);\n            if (deliveryDate > oneHourFromNow) {\n                dates.push(deliveryDate);\n            }\n        }\n\n        // Move to next day\n        scanDate.setDate(scanDate.getDate() + 1);\n    }\n\n    return dates;\n}\n\n/**\n * Schedule Email Deliveries\n *\n * Triggered when a user approves their drafts.\n * Assigns each approved (unscheduled) draft to the next available\n * delivery day based on the user's delivery_days preference.\n *\n * Then triggers send-to-mailchimp with a scheduleTime for each.\n */\nexport const scheduleEmailDeliveries = task({\n    id: \"schedule-email-deliveries\",\n    machine: { preset: \"small-1x\" },\n    retry: {\n        maxAttempts: 2,\n        factor: 1.5,\n        minTimeoutInMs: 2000,\n        maxTimeoutInMs: 15_000,\n    },\n    run: async (payload: { userId: string }) => {\n        const { userId } = payload;\n\n        logger.info(\"ðŸ“… Scheduling email deliveries\", { userId });\n        metadata.set(\"status\", \"loading\").set(\"userId\", userId);\n\n        // 1. Fetch user's delivery days and timezone\n        const { data: profile, error: profileError } = await supabase\n            .from(\"profiles\")\n            .select(\"delivery_days, email\")\n            .eq(\"id\", userId)\n            .single();\n\n        if (profileError || !profile) {\n            throw new AbortTaskRunError(\n                `Profile not found: ${profileError?.message || \"no data\"}`\n            );\n        }\n\n        const deliveryDays: string[] = profile.delivery_days || [\"thursday\"];\n\n        logger.info(\"Delivery days\", { deliveryDays });\n\n        // 2. Fetch approved but unscheduled drafts\n        const { data: drafts, error: draftsError } = await supabase\n            .from(\"email_drafts\")\n            .select(\"id, subject_line\")\n            .eq(\"user_id\", userId)\n            .eq(\"status\", \"approved\")\n            .is(\"scheduled_for\", null)\n            .order(\"created_at\", { ascending: true });\n\n        if (draftsError) {\n            throw new Error(`Failed to fetch drafts: ${draftsError.message}`);\n        }\n\n        if (!drafts || drafts.length === 0) {\n            logger.info(\"No approved unscheduled drafts found\");\n            return { scheduled: 0 };\n        }\n\n        logger.info(`Found ${drafts.length} drafts to schedule`);\n        metadata.set(\"status\", \"calculating\").set(\"draftsToSchedule\", drafts.length);\n\n        // 3. Calculate next delivery dates\n        const deliveryDates = getNextDeliveryDates(\n            deliveryDays,\n            drafts.length,\n            9, // 9am\n            \"America/Chicago\" // Default timezone, could be per-user\n        );\n\n        if (deliveryDates.length < drafts.length) {\n            logger.warn(\"Not enough delivery dates generated\", {\n                needed: drafts.length,\n                generated: deliveryDates.length,\n            });\n        }\n\n        // 4. Assign each draft to a delivery date and trigger send\n        metadata.set(\"status\", \"scheduling\");\n        const scheduled: Array<{ draftId: string; scheduledFor: string }> = [];\n\n        for (let i = 0; i < drafts.length; i++) {\n            const draft = drafts[i];\n            const deliveryDate = deliveryDates[i];\n\n            if (!deliveryDate) {\n                logger.warn(`No delivery date for draft ${i + 1}`, { draftId: draft.id });\n                continue;\n            }\n\n            const scheduledFor = deliveryDate.toISOString();\n\n            // Update draft with scheduled_for and status\n            const { error: updateError } = await supabase\n                .from(\"email_drafts\")\n                .update({\n                    scheduled_for: scheduledFor,\n                    status: \"scheduled\",\n                })\n                .eq(\"id\", draft.id);\n\n            if (updateError) {\n                logger.error(\"Failed to update draft schedule\", {\n                    draftId: draft.id,\n                    error: updateError.message,\n                });\n                continue;\n            }\n\n            // Trigger send-to-mailchimp with schedule time\n            try {\n                const { tasks } = await import(\"@trigger.dev/sdk\");\n                await tasks.trigger(\"send-to-mailchimp\", {\n                    draftId: draft.id,\n                    userId,\n                    scheduleTime: scheduledFor,\n                });\n\n                scheduled.push({ draftId: draft.id, scheduledFor });\n\n                logger.info(`Scheduled draft`, {\n                    draftId: draft.id,\n                    subject: draft.subject_line,\n                    scheduledFor,\n                });\n            } catch (err) {\n                logger.error(\"Failed to trigger send task\", {\n                    draftId: draft.id,\n                    error: (err as Error).message,\n                });\n            }\n\n            metadata.increment(\"scheduledCount\", 1);\n        }\n\n        metadata.set(\"status\", \"completed\");\n\n        logger.info(\"Scheduling complete\", {\n            total: drafts.length,\n            scheduled: scheduled.length,\n        });\n\n        return {\n            total: drafts.length,\n            scheduled: scheduled.length,\n            deliveries: scheduled,\n        };\n    },\n});\n"],
  "mappings": "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",
  "names": []
}
