{
  "version": 3,
  "sources": ["../../../../../../trigger/research-topics.ts"],
  "sourcesContent": ["import { task, logger, metadata } from \"@trigger.dev/sdk\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst supabase = createClient(\n    process.env.SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\n// ‚îÄ‚îÄ Perplexity Search API types ‚îÄ‚îÄ\ninterface PerplexitySearchResult {\n    title: string;\n    url: string;\n    snippet: string;\n    date: string | null;\n    last_updated: string | null;\n}\n\ninterface PerplexitySearchResponse {\n    results: PerplexitySearchResult[];\n    id: string;\n}\n\ninterface ScoredTopic {\n    title: string;\n    summary: string;\n    source_url: string;\n    source_domain: string;\n    content_snippet: string;\n    relevance_score: number;\n}\n\n/**\n * Research Topics ‚Äî AI Content Researcher\n *\n * Searches the web via Perplexity Search API for relevant news and trends\n * that can be used in fundraising email copy.\n *\n * Cost: $0.005 per request, no token costs.\n */\nexport const researchTopics = task({\n    id: \"research-topics\",\n    machine: { preset: \"small-1x\" },\n    retry: {\n        maxAttempts: 2,\n        factor: 1.5,\n        minTimeoutInMs: 2000,\n        maxTimeoutInMs: 15_000,\n    },\n    run: async (payload: {\n        userId: string;\n        query: string;\n        suggestedBy?: \"user\" | \"ai\";\n    }) => {\n        const { userId, query, suggestedBy = \"user\" } = payload;\n\n        logger.info(\"üîç Research starting\", { userId, query, suggestedBy });\n        metadata.set(\"status\", \"searching\").set(\"query\", query);\n\n        // 1. Search via Perplexity Search API\n        const searchResults = await perplexitySearch(query);\n\n        if (!searchResults || searchResults.length === 0) {\n            logger.info(\"No results found\", { query });\n            return { saved: 0, query };\n        }\n\n        logger.info(`Found ${searchResults.length} results`, { query });\n        metadata.set(\"status\", \"scoring\").set(\"resultsFound\", searchResults.length);\n\n        // 2. Score and rank results locally (no AI needed ‚Äî saves cost)\n        const scoredTopics = scoreResults(searchResults, query);\n\n        // 3. Save top results to database\n        const topTopics = scoredTopics.slice(0, 5);\n        const savedIds: string[] = [];\n\n        for (const topic of topTopics) {\n            const { data, error } = await supabase\n                .from(\"research_topics\")\n                .insert({\n                    user_id: userId,\n                    title: topic.title,\n                    summary: topic.summary,\n                    source_url: topic.source_url,\n                    source_domain: topic.source_domain,\n                    content_snippet: topic.content_snippet,\n                    relevance_score: topic.relevance_score,\n                    suggested_by: suggestedBy,\n                    used_in_draft: false,\n                })\n                .select(\"id\")\n                .single();\n\n            if (!error && data) {\n                savedIds.push(data.id);\n            } else {\n                logger.error(\"Failed to save topic\", {\n                    title: topic.title,\n                    error: error?.message,\n                });\n            }\n        }\n\n        metadata.set(\"status\", \"completed\").set(\"savedCount\", savedIds.length);\n\n        logger.info(\"Research complete\", {\n            query,\n            found: searchResults.length,\n            saved: savedIds.length,\n        });\n\n        return {\n            query,\n            found: searchResults.length,\n            saved: savedIds.length,\n            topicIds: savedIds,\n        };\n    },\n});\n\n// ‚îÄ‚îÄ Perplexity Search API ‚îÄ‚îÄ\n// Endpoint: POST https://api.perplexity.ai/search\n// Cost: $5 per 1K requests ($0.005/request), no token costs\nasync function perplexitySearch(\n    query: string\n): Promise<PerplexitySearchResult[]> {\n    const apiKey = process.env.PERPLEXITY_API_KEY;\n    if (!apiKey) throw new Error(\"PERPLEXITY_API_KEY not set\");\n\n    try {\n        const response = await fetch(\"https://api.perplexity.ai/search\", {\n            method: \"POST\",\n            headers: {\n                \"Content-Type\": \"application/json\",\n                Authorization: `Bearer ${apiKey}`,\n            },\n            body: JSON.stringify({\n                query,\n                max_results: 10,\n                search_recency_filter: \"week\",\n                search_domain_filter: [\n                    \"nytimes.com\",\n                    \"washingtonpost.com\",\n                    \"politico.com\",\n                    \"thehill.com\",\n                    \"cnn.com\",\n                    \"reuters.com\",\n                    \"apnews.com\",\n                    \"npr.org\",\n                    \"axios.com\",\n                    \"nbcnews.com\",\n                    \"fec.gov\",\n                    \"opensecrets.org\",\n                ],\n            }),\n        });\n\n        if (!response.ok) {\n            const errorText = await response.text();\n            logger.error(\"Perplexity Search API error\", {\n                status: response.status,\n                body: errorText,\n            });\n            return [];\n        }\n\n        const data = (await response.json()) as PerplexitySearchResponse;\n        return data.results || [];\n    } catch (err) {\n        logger.error(\"Perplexity search failed\", {\n            error: (err as Error).message,\n        });\n        return [];\n    }\n}\n\n// ‚îÄ‚îÄ Local scoring (no AI cost) ‚îÄ‚îÄ\nfunction scoreResults(\n    results: PerplexitySearchResult[],\n    query: string\n): ScoredTopic[] {\n    const queryTerms = query.toLowerCase().split(/\\s+/);\n\n    return results\n        .map((result) => {\n            let score = 0;\n\n            // Title relevance (strongest signal)\n            const titleLower = result.title.toLowerCase();\n            for (const term of queryTerms) {\n                if (titleLower.includes(term)) score += 3;\n            }\n\n            // Snippet relevance\n            const snippetLower = result.snippet.toLowerCase();\n            for (const term of queryTerms) {\n                if (snippetLower.includes(term)) score += 2;\n            }\n\n            // Recency bonus\n            if (result.date) {\n                const daysAgo = daysSince(result.date);\n                if (daysAgo <= 1) score += 4;\n                else if (daysAgo <= 3) score += 3;\n                else if (daysAgo <= 7) score += 2;\n            }\n\n            // Source quality\n            const domain = extractDomain(result.url);\n            const tier1 = [\n                \"nytimes.com\",\n                \"washingtonpost.com\",\n                \"reuters.com\",\n                \"apnews.com\",\n            ];\n            const tier2 = [\n                \"politico.com\",\n                \"thehill.com\",\n                \"cnn.com\",\n                \"npr.org\",\n                \"axios.com\",\n                \"fec.gov\",\n            ];\n            if (tier1.some((d) => domain.includes(d))) score += 3;\n            else if (tier2.some((d) => domain.includes(d))) score += 2;\n\n            // Normalize to 0-10\n            const normalizedScore = Math.min(score / 15, 1) * 10;\n\n            return {\n                title: result.title,\n                summary: result.snippet,\n                source_url: result.url,\n                source_domain: domain,\n                content_snippet: result.snippet.slice(0, 300),\n                relevance_score: Math.round(normalizedScore * 100) / 100,\n            };\n        })\n        .sort((a, b) => b.relevance_score - a.relevance_score);\n}\n\nfunction extractDomain(url: string): string {\n    try {\n        return new URL(url).hostname.replace(\"www.\", \"\");\n    } catch {\n        return \"\";\n    }\n}\n\nfunction daysSince(dateStr: string): number {\n    try {\n        const date = new Date(dateStr);\n        const now = new Date();\n        return Math.max(0, (now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24));\n    } catch {\n        return 999;\n    }\n}\n"],
  "mappings": "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",
  "names": []
}
