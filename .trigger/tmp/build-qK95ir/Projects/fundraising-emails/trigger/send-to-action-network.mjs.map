{
  "version": 3,
  "sources": ["../../../../../../trigger/send-to-action-network.ts"],
  "sourcesContent": ["import { task, logger, metadata, wait, AbortTaskRunError } from \"@trigger.dev/sdk\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst supabase = createClient(\n    process.env.SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nconst AN_BASE_URL = \"https://actionnetwork.org/api/v2\";\n\n/**\n * Helper: make authenticated Action Network API calls\n */\nasync function anFetch(\n    apiKey: string,\n    path: string,\n    options: RequestInit = {}\n): Promise<Response> {\n    const url = path.startsWith(\"http\") ? path : `${AN_BASE_URL}${path}`;\n    const response = await fetch(url, {\n        ...options,\n        headers: {\n            \"Content-Type\": \"application/json\",\n            \"OSDI-API-Token\": apiKey,\n            ...(options.headers || {}),\n        },\n    });\n\n    if (!response.ok) {\n        const errorBody = await response.text();\n        throw new Error(\n            `Action Network API error (${response.status}): ${errorBody}`\n        );\n    }\n\n    return response;\n}\n\n/**\n * Send to Action Network ‚Äî 3-step email flow\n *\n * 1. POST /messages ‚Üí create message with subject, body, from, reply_to\n * 2. Poll GET /messages/{id} ‚Üí wait for status='draft' + total_targeted > 0\n * 3. POST /messages/{id}/send/ ‚Üí send immediately\n *    OR POST /messages/{id}/schedule/ ‚Üí schedule for later\n */\nexport const sendToActionNetwork = task({\n    id: \"send-to-action-network\",\n    machine: { preset: \"small-1x\" },\n    retry: {\n        maxAttempts: 3,\n        factor: 1.8,\n        minTimeoutInMs: 3000,\n        maxTimeoutInMs: 30_000,\n    },\n    run: async (payload: {\n        draftId: string;\n        userId: string;\n        scheduleTime?: string;\n    }) => {\n        const { draftId, userId, scheduleTime } = payload;\n\n        logger.info(\"üì¢ Send to Action Network starting\", {\n            draftId,\n            userId,\n            scheduleTime: scheduleTime || \"immediate\",\n        });\n        metadata.set(\"status\", \"fetching_draft\").set(\"draftId\", draftId);\n\n        // ‚îÄ‚îÄ 1. Fetch the approved draft ‚îÄ‚îÄ\n        const { data: draft, error: draftError } = await supabase\n            .from(\"email_drafts\")\n            .select(\"*\")\n            .eq(\"id\", draftId)\n            .eq(\"user_id\", userId)\n            .single();\n\n        if (draftError || !draft) {\n            throw new AbortTaskRunError(\n                `Draft not found: ${draftError?.message || \"no data\"}`\n            );\n        }\n\n        if (draft.status !== \"approved\" && draft.status !== \"scheduled\") {\n            throw new AbortTaskRunError(\n                `Draft status is \"${draft.status}\", expected \"approved\" or \"scheduled\"`\n            );\n        }\n\n        // ‚îÄ‚îÄ 2. Fetch Action Network credentials ‚îÄ‚îÄ\n        metadata.set(\"status\", \"fetching_credentials\");\n\n        const { data: integration, error: intError } = await supabase\n            .from(\"email_integrations\")\n            .select(\"*\")\n            .eq(\"user_id\", userId)\n            .eq(\"provider\", \"action_network\")\n            .single();\n\n        if (intError || !integration) {\n            throw new AbortTaskRunError(\n                `Action Network not connected: ${intError?.message || \"no integration found\"}`\n            );\n        }\n\n        const apiKey = integration.access_token;\n\n        // ‚îÄ‚îÄ 3. Fetch brand kit for from_name ‚îÄ‚îÄ\n        const { data: brandKit } = await supabase\n            .from(\"brand_kits\")\n            .select(\"kit_name\")\n            .eq(\"user_id\", userId)\n            .single();\n\n        const fromName = brandKit?.kit_name || \"Our Campaign\";\n        const replyTo =\n            (draft as Record<string, string>).reply_to ||\n            integration.metadata?.reply_to ||\n            \"noreply@example.com\";\n\n        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n        // STEP 1: Create message\n        // POST /api/v2/messages\n        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n        metadata.set(\"status\", \"step_1_creating_message\");\n        logger.info(\"Step 1: Creating Action Network message\");\n\n        const createResponse = await anFetch(apiKey, \"/messages\", {\n            method: \"POST\",\n            body: JSON.stringify({\n                subject: draft.subject_line,\n                body: draft.body_html || draft.body_text || \"\",\n                from: fromName,\n                reply_to: replyTo,\n            }),\n        });\n\n        const message = await createResponse.json();\n        const messageId =\n            message.identifiers?.[0]?.replace(\"action_network:\", \"\") ||\n            message._links?.self?.href?.split(\"/\").pop();\n\n        if (!messageId) {\n            throw new Error(\"Failed to extract message ID from Action Network response\");\n        }\n\n        const messageUrl =\n            message._links?.self?.href ||\n            `${AN_BASE_URL}/messages/${messageId}`;\n\n        logger.info(\"Message created\", {\n            messageId,\n            status: message.status,\n        });\n\n        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n        // STEP 2: Poll until targeting is done\n        // GET /api/v2/messages/{id}\n        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n        metadata.set(\"status\", \"step_2_polling_targeting\");\n        logger.info(\"Step 2: Polling until targeting finishes\");\n\n        let attempts = 0;\n        const maxAttempts = 30; // 30 * 5s = 2.5min max wait\n        let currentStatus = message.status;\n\n        while (currentStatus === \"calculating\" && attempts < maxAttempts) {\n            attempts++;\n            logger.info(`Polling attempt ${attempts}/${maxAttempts}`, {\n                status: currentStatus,\n            });\n\n            // Wait 5 seconds between polls (checkpointed by Trigger.dev)\n            await wait.for({ seconds: 5 });\n\n            const pollResponse = await anFetch(apiKey, messageUrl);\n            const pollData = await pollResponse.json();\n            currentStatus = pollData.status;\n\n            if (currentStatus === \"draft\" && pollData.total_targeted > 0) {\n                logger.info(\"Targeting complete\", {\n                    totalTargeted: pollData.total_targeted,\n                });\n                break;\n            }\n        }\n\n        if (currentStatus === \"calculating\") {\n            throw new Error(\n                `Targeting still calculating after ${maxAttempts * 5}s ‚Äî message_id: ${messageId}`\n            );\n        }\n\n        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n        // STEP 3: Send or Schedule\n        // POST /messages/{id}/send/ (immediate)\n        // POST /messages/{id}/schedule/ (scheduled)\n        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n        if (scheduleTime) {\n            metadata.set(\"status\", \"step_3_scheduling\");\n            logger.info(\"Step 3: Scheduling message\", { scheduleTime });\n\n            const scheduleUrl =\n                message._links?.[\"osdi:schedule_helper\"]?.href ||\n                `${messageUrl}/schedule/`;\n\n            await anFetch(apiKey, scheduleUrl, {\n                method: \"POST\",\n                body: JSON.stringify({\n                    scheduled_date: scheduleTime,\n                }),\n            });\n\n            logger.info(\"üìÖ Message scheduled!\", { messageId, scheduleTime });\n        } else {\n            metadata.set(\"status\", \"step_3_sending\");\n            logger.info(\"Step 3: Sending message immediately\");\n\n            const sendUrl =\n                message._links?.[\"osdi:send_helper\"]?.href ||\n                `${messageUrl}/send/`;\n\n            await anFetch(apiKey, sendUrl, {\n                method: \"POST\",\n                body: JSON.stringify({}),\n            });\n\n            logger.info(\"üéâ Message sent!\", { messageId });\n        }\n\n        const sentAt = scheduleTime || new Date().toISOString();\n\n        // ‚îÄ‚îÄ Update draft status in Supabase ‚îÄ‚îÄ\n        metadata.set(\"status\", \"updating_draft\");\n\n        const { error: updateError } = await supabase\n            .from(\"email_drafts\")\n            .update({\n                status: scheduleTime ? \"scheduled\" : \"sent\",\n                sent_at: scheduleTime ? null : sentAt,\n                scheduled_for: scheduleTime || null,\n            })\n            .eq(\"id\", draftId);\n\n        if (updateError) {\n            logger.error(\"Failed to update draft status\", {\n                error: updateError.message,\n            });\n        }\n\n        metadata.set(\"status\", \"completed\");\n\n        return {\n            draftId,\n            messageId,\n            sentAt: scheduleTime ? null : sentAt,\n            scheduledFor: scheduleTime || null,\n            subject: draft.subject_line,\n            fromName,\n            replyTo,\n        };\n    },\n});\n"],
  "mappings": "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",
  "names": []
}
