{
  "version": 3,
  "sources": ["../../../../../../trigger/send-to-mailchimp.ts"],
  "sourcesContent": ["import { task, logger, metadata, AbortTaskRunError } from \"@trigger.dev/sdk\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst supabase = createClient(\n    process.env.SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\n// â”€â”€ Types â”€â”€\n\ninterface MailchimpCredentials {\n    access_token: string;\n    server_prefix: string;\n    list_id: string;\n}\n\ninterface SendChecklistResponse {\n    is_ready: boolean;\n    items: Array<{\n        type: \"success\" | \"warning\" | \"error\";\n        id: number;\n        heading: string;\n        details: string;\n    }>;\n}\n\ninterface CreateCampaignResponse {\n    id: string;\n    status: string;\n    web_id: number;\n}\n\n// â”€â”€ Mailchimp API helpers â”€â”€\n\nfunction mailchimpUrl(serverPrefix: string, path: string): string {\n    return `https://${serverPrefix}.api.mailchimp.com/3.0${path}`;\n}\n\nfunction mailchimpHeaders(accessToken: string): Record<string, string> {\n    return {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${accessToken}`,\n    };\n}\n\nasync function mailchimpFetch<T>(\n    serverPrefix: string,\n    accessToken: string,\n    path: string,\n    options: RequestInit = {}\n): Promise<T> {\n    const url = mailchimpUrl(serverPrefix, path);\n    const response = await fetch(url, {\n        ...options,\n        headers: {\n            ...mailchimpHeaders(accessToken),\n            ...(options.headers || {}),\n        },\n    });\n\n    if (!response.ok) {\n        const errorBody = await response.text();\n        logger.error(\"Mailchimp API error\", {\n            status: response.status,\n            path,\n            body: errorBody,\n        });\n        throw new Error(\n            `Mailchimp API ${response.status}: ${errorBody.slice(0, 200)}`\n        );\n    }\n\n    // Some endpoints return 204 No Content (e.g., send)\n    if (response.status === 204) {\n        return {} as T;\n    }\n\n    return response.json() as Promise<T>;\n}\n\n/**\n * Send to Mailchimp â€” Approved Draft â†’ Campaign â†’ Send\n *\n * Executes the 4-step Mailchimp Campaign API flow:\n *   1. Create campaign (sets audience, subject, sender)\n *   2. Set content (fills with draft HTML)\n *   3. Validate send checklist\n *   4. Send to all recipients\n *\n * Triggered when a draft status changes to \"approved\".\n */\nexport const sendToMailchimp = task({\n    id: \"send-to-mailchimp\",\n    machine: { preset: \"small-1x\" },\n    retry: {\n        maxAttempts: 3,\n        factor: 2,\n        minTimeoutInMs: 3000,\n        maxTimeoutInMs: 30_000,\n    },\n    run: async (payload: { draftId: string; userId: string }) => {\n        const { draftId, userId } = payload;\n\n        logger.info(\"ğŸ“¬ Send to Mailchimp starting\", { draftId, userId });\n        metadata.set(\"status\", \"fetching_draft\").set(\"draftId\", draftId);\n\n        // â”€â”€ 1. Fetch the approved draft â”€â”€\n        const { data: draft, error: draftError } = await supabase\n            .from(\"email_drafts\")\n            .select(\"id, subject_line, body_html, body_text, status, user_id\")\n            .eq(\"id\", draftId)\n            .eq(\"user_id\", userId)\n            .single();\n\n        if (draftError || !draft) {\n            throw new AbortTaskRunError(\n                `Draft not found: ${draftError?.message || \"no data\"}`\n            );\n        }\n\n        if (draft.status !== \"approved\") {\n            throw new AbortTaskRunError(\n                `Draft status is \"${draft.status}\", expected \"approved\"`\n            );\n        }\n\n        if (!draft.body_html) {\n            throw new AbortTaskRunError(\"Draft has no HTML body\");\n        }\n\n        logger.info(\"Draft fetched\", {\n            subject: draft.subject_line,\n            hasHtml: !!draft.body_html,\n        });\n\n        // â”€â”€ 2. Fetch Mailchimp credentials â”€â”€\n        metadata.set(\"status\", \"fetching_credentials\");\n\n        const { data: creds, error: credsError } = await supabase\n            .from(\"email_integrations\")\n            .select(\"access_token, server_prefix, list_id, metadata\")\n            .eq(\"user_id\", userId)\n            .eq(\"provider\", \"mailchimp\")\n            .single();\n\n        if (credsError || !creds) {\n            throw new AbortTaskRunError(\n                `Mailchimp not connected: ${credsError?.message || \"no integration found\"}`\n            );\n        }\n\n        if (!creds.server_prefix || !creds.list_id) {\n            throw new AbortTaskRunError(\n                \"Mailchimp integration is missing server_prefix or list_id\"\n            );\n        }\n\n        const mc: MailchimpCredentials = {\n            access_token: creds.access_token,\n            server_prefix: creds.server_prefix,\n            list_id: creds.list_id,\n        };\n\n        logger.info(\"Credentials loaded\", {\n            server: mc.server_prefix,\n            listId: mc.list_id,\n        });\n\n        // â”€â”€ 3. Fetch sender info from brand kit â”€â”€\n        const { data: brandKit } = await supabase\n            .from(\"brand_kits\")\n            .select(\"kit_name\")\n            .eq(\"user_id\", userId)\n            .single();\n\n        const { data: profile } = await supabase\n            .from(\"profiles\")\n            .select(\"email, organization_name\")\n            .eq(\"id\", userId)\n            .single();\n\n        const fromName =\n            brandKit?.kit_name ||\n            profile?.organization_name ||\n            \"Campaign\";\n        const replyTo = profile?.email || \"noreply@example.com\";\n\n        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        // STEP 1: Create Campaign\n        // POST /campaigns\n        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        metadata.set(\"status\", \"step_1_create_campaign\");\n        logger.info(\"Step 1: Creating Mailchimp campaign\");\n\n        const campaign = await mailchimpFetch<CreateCampaignResponse>(\n            mc.server_prefix,\n            mc.access_token,\n            \"/campaigns\",\n            {\n                method: \"POST\",\n                body: JSON.stringify({\n                    type: \"regular\",\n                    recipients: { list_id: mc.list_id },\n                    settings: {\n                        subject_line: draft.subject_line || \"(No Subject)\",\n                        from_name: fromName,\n                        reply_to: replyTo,\n                    },\n                }),\n            }\n        );\n\n        const campaignId = campaign.id;\n        logger.info(\"Campaign created\", { campaignId });\n        metadata.set(\"mailchimpCampaignId\", campaignId);\n\n        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        // STEP 2: Set Content\n        // PUT /campaigns/{id}/content\n        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        metadata.set(\"status\", \"step_2_set_content\");\n        logger.info(\"Step 2: Setting campaign content\");\n\n        await mailchimpFetch(\n            mc.server_prefix,\n            mc.access_token,\n            `/campaigns/${campaignId}/content`,\n            {\n                method: \"PUT\",\n                body: JSON.stringify({\n                    html: draft.body_html,\n                }),\n            }\n        );\n\n        logger.info(\"Content set successfully\");\n\n        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        // STEP 3: Validate (Send Checklist)\n        // GET /campaigns/{id}/send-checklist\n        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        metadata.set(\"status\", \"step_3_validate\");\n        logger.info(\"Step 3: Running send checklist\");\n\n        const checklist = await mailchimpFetch<SendChecklistResponse>(\n            mc.server_prefix,\n            mc.access_token,\n            `/campaigns/${campaignId}/send-checklist`\n        );\n\n        const errors = checklist.items.filter((i) => i.type === \"error\");\n        const warnings = checklist.items.filter((i) => i.type === \"warning\");\n\n        logger.info(\"Send checklist result\", {\n            isReady: checklist.is_ready,\n            errors: errors.length,\n            warnings: warnings.length,\n        });\n\n        if (!checklist.is_ready) {\n            const errorDetails = errors\n                .map((e) => `${e.heading}: ${e.details}`)\n                .join(\"; \");\n\n            // Log the full checklist for debugging\n            logger.error(\"Send checklist failed\", {\n                campaignId,\n                items: checklist.items,\n            });\n\n            throw new Error(\n                `Mailchimp send checklist failed: ${errorDetails || \"Unknown error\"}`\n            );\n        }\n\n        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        // STEP 4: Send!\n        // POST /campaigns/{id}/actions/send\n        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        metadata.set(\"status\", \"step_4_sending\");\n        logger.info(\"Step 4: Sending campaign\");\n\n        await mailchimpFetch(\n            mc.server_prefix,\n            mc.access_token,\n            `/campaigns/${campaignId}/actions/send`,\n            { method: \"POST\" }\n        );\n\n        const sentAt = new Date().toISOString();\n        logger.info(\"ğŸ‰ Campaign sent successfully!\", { campaignId, sentAt });\n\n        // â”€â”€ Update draft status in Supabase â”€â”€\n        metadata.set(\"status\", \"updating_draft\");\n\n        const { error: updateError } = await supabase\n            .from(\"email_drafts\")\n            .update({\n                status: \"sent\",\n                sent_at: sentAt,\n                mailchimp_campaign_id: campaignId,\n            })\n            .eq(\"id\", draftId);\n\n        if (updateError) {\n            // Non-fatal: the email was sent, just the DB didn't update\n            logger.error(\"Failed to update draft status\", {\n                draftId,\n                error: updateError.message,\n            });\n        }\n\n        metadata.set(\"status\", \"completed\");\n\n        return {\n            draftId,\n            campaignId,\n            sentAt,\n            subject: draft.subject_line,\n            fromName,\n            replyTo,\n        };\n    },\n});\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAGA,IAAM,WAAW;AAAA,EACb,QAAQ,IAAI;AAAA,EACZ,QAAQ,IAAI;AAChB;AA4BA,SAAS,aAAa,cAAsB,MAAsB;AAC9D,SAAO,WAAW,YAAY,yBAAyB,IAAI;AAC/D;AAFS;AAIT,SAAS,iBAAiB,aAA6C;AACnE,SAAO;AAAA,IACH,gBAAgB;AAAA,IAChB,eAAe,UAAU,WAAW;AAAA,EACxC;AACJ;AALS;AAOT,eAAe,eACX,cACA,aACA,MACA,UAAuB,CAAC,GACd;AACV,QAAM,MAAM,aAAa,cAAc,IAAI;AAC3C,QAAM,WAAW,MAAM,MAAM,KAAK;AAAA,IAC9B,GAAG;AAAA,IACH,SAAS;AAAA,MACL,GAAG,iBAAiB,WAAW;AAAA,MAC/B,GAAI,QAAQ,WAAW,CAAC;AAAA,IAC5B;AAAA,EACJ,CAAC;AAED,MAAI,CAAC,SAAS,IAAI;AACd,UAAM,YAAY,MAAM,SAAS,KAAK;AACtC,WAAO,MAAM,uBAAuB;AAAA,MAChC,QAAQ,SAAS;AAAA,MACjB;AAAA,MACA,MAAM;AAAA,IACV,CAAC;AACD,UAAM,IAAI;AAAA,MACN,iBAAiB,SAAS,MAAM,KAAK,UAAU,MAAM,GAAG,GAAG,CAAC;AAAA,IAChE;AAAA,EACJ;AAGA,MAAI,SAAS,WAAW,KAAK;AACzB,WAAO,CAAC;AAAA,EACZ;AAEA,SAAO,SAAS,KAAK;AACzB;AAjCe;AA8CR,IAAM,kBAAkB,KAAK;AAAA,EAChC,IAAI;AAAA,EACJ,SAAS,EAAE,QAAQ,WAAW;AAAA,EAC9B,OAAO;AAAA,IACH,aAAa;AAAA,IACb,QAAQ;AAAA,IACR,gBAAgB;AAAA,IAChB,gBAAgB;AAAA,EACpB;AAAA,EACA,KAAK,8BAAO,YAAiD;AACzD,UAAM,EAAE,SAAS,OAAO,IAAI;AAE5B,WAAO,KAAK,iCAAiC,EAAE,SAAS,OAAO,CAAC;AAChE,aAAS,IAAI,UAAU,gBAAgB,EAAE,IAAI,WAAW,OAAO;AAG/D,UAAM,EAAE,MAAM,OAAO,OAAO,WAAW,IAAI,MAAM,SAC5C,KAAK,cAAc,EACnB,OAAO,yDAAyD,EAChE,GAAG,MAAM,OAAO,EAChB,GAAG,WAAW,MAAM,EACpB,OAAO;AAEZ,QAAI,cAAc,CAAC,OAAO;AACtB,YAAM,IAAI;AAAA,QACN,oBAAoB,YAAY,WAAW,SAAS;AAAA,MACxD;AAAA,IACJ;AAEA,QAAI,MAAM,WAAW,YAAY;AAC7B,YAAM,IAAI;AAAA,QACN,oBAAoB,MAAM,MAAM;AAAA,MACpC;AAAA,IACJ;AAEA,QAAI,CAAC,MAAM,WAAW;AAClB,YAAM,IAAI,kBAAkB,wBAAwB;AAAA,IACxD;AAEA,WAAO,KAAK,iBAAiB;AAAA,MACzB,SAAS,MAAM;AAAA,MACf,SAAS,CAAC,CAAC,MAAM;AAAA,IACrB,CAAC;AAGD,aAAS,IAAI,UAAU,sBAAsB;AAE7C,UAAM,EAAE,MAAM,OAAO,OAAO,WAAW,IAAI,MAAM,SAC5C,KAAK,oBAAoB,EACzB,OAAO,gDAAgD,EACvD,GAAG,WAAW,MAAM,EACpB,GAAG,YAAY,WAAW,EAC1B,OAAO;AAEZ,QAAI,cAAc,CAAC,OAAO;AACtB,YAAM,IAAI;AAAA,QACN,4BAA4B,YAAY,WAAW,sBAAsB;AAAA,MAC7E;AAAA,IACJ;AAEA,QAAI,CAAC,MAAM,iBAAiB,CAAC,MAAM,SAAS;AACxC,YAAM,IAAI;AAAA,QACN;AAAA,MACJ;AAAA,IACJ;AAEA,UAAM,KAA2B;AAAA,MAC7B,cAAc,MAAM;AAAA,MACpB,eAAe,MAAM;AAAA,MACrB,SAAS,MAAM;AAAA,IACnB;AAEA,WAAO,KAAK,sBAAsB;AAAA,MAC9B,QAAQ,GAAG;AAAA,MACX,QAAQ,GAAG;AAAA,IACf,CAAC;AAGD,UAAM,EAAE,MAAM,SAAS,IAAI,MAAM,SAC5B,KAAK,YAAY,EACjB,OAAO,UAAU,EACjB,GAAG,WAAW,MAAM,EACpB,OAAO;AAEZ,UAAM,EAAE,MAAM,QAAQ,IAAI,MAAM,SAC3B,KAAK,UAAU,EACf,OAAO,0BAA0B,EACjC,GAAG,MAAM,MAAM,EACf,OAAO;AAEZ,UAAM,WACF,UAAU,YACV,SAAS,qBACT;AACJ,UAAM,UAAU,SAAS,SAAS;AAMlC,aAAS,IAAI,UAAU,wBAAwB;AAC/C,WAAO,KAAK,qCAAqC;AAEjD,UAAM,WAAW,MAAM;AAAA,MACnB,GAAG;AAAA,MACH,GAAG;AAAA,MACH;AAAA,MACA;AAAA,QACI,QAAQ;AAAA,QACR,MAAM,KAAK,UAAU;AAAA,UACjB,MAAM;AAAA,UACN,YAAY,EAAE,SAAS,GAAG,QAAQ;AAAA,UAClC,UAAU;AAAA,YACN,cAAc,MAAM,gBAAgB;AAAA,YACpC,WAAW;AAAA,YACX,UAAU;AAAA,UACd;AAAA,QACJ,CAAC;AAAA,MACL;AAAA,IACJ;AAEA,UAAM,aAAa,SAAS;AAC5B,WAAO,KAAK,oBAAoB,EAAE,WAAW,CAAC;AAC9C,aAAS,IAAI,uBAAuB,UAAU;AAM9C,aAAS,IAAI,UAAU,oBAAoB;AAC3C,WAAO,KAAK,kCAAkC;AAE9C,UAAM;AAAA,MACF,GAAG;AAAA,MACH,GAAG;AAAA,MACH,cAAc,UAAU;AAAA,MACxB;AAAA,QACI,QAAQ;AAAA,QACR,MAAM,KAAK,UAAU;AAAA,UACjB,MAAM,MAAM;AAAA,QAChB,CAAC;AAAA,MACL;AAAA,IACJ;AAEA,WAAO,KAAK,0BAA0B;AAMtC,aAAS,IAAI,UAAU,iBAAiB;AACxC,WAAO,KAAK,gCAAgC;AAE5C,UAAM,YAAY,MAAM;AAAA,MACpB,GAAG;AAAA,MACH,GAAG;AAAA,MACH,cAAc,UAAU;AAAA,IAC5B;AAEA,UAAM,SAAS,UAAU,MAAM,OAAO,CAAC,MAAM,EAAE,SAAS,OAAO;AAC/D,UAAM,WAAW,UAAU,MAAM,OAAO,CAAC,MAAM,EAAE,SAAS,SAAS;AAEnE,WAAO,KAAK,yBAAyB;AAAA,MACjC,SAAS,UAAU;AAAA,MACnB,QAAQ,OAAO;AAAA,MACf,UAAU,SAAS;AAAA,IACvB,CAAC;AAED,QAAI,CAAC,UAAU,UAAU;AACrB,YAAM,eAAe,OAChB,IAAI,CAAC,MAAM,GAAG,EAAE,OAAO,KAAK,EAAE,OAAO,EAAE,EACvC,KAAK,IAAI;AAGd,aAAO,MAAM,yBAAyB;AAAA,QAClC;AAAA,QACA,OAAO,UAAU;AAAA,MACrB,CAAC;AAED,YAAM,IAAI;AAAA,QACN,oCAAoC,gBAAgB,eAAe;AAAA,MACvE;AAAA,IACJ;AAMA,aAAS,IAAI,UAAU,gBAAgB;AACvC,WAAO,KAAK,0BAA0B;AAEtC,UAAM;AAAA,MACF,GAAG;AAAA,MACH,GAAG;AAAA,MACH,cAAc,UAAU;AAAA,MACxB,EAAE,QAAQ,OAAO;AAAA,IACrB;AAEA,UAAM,UAAS,oBAAI,KAAK,GAAE,YAAY;AACtC,WAAO,KAAK,kCAAkC,EAAE,YAAY,OAAO,CAAC;AAGpE,aAAS,IAAI,UAAU,gBAAgB;AAEvC,UAAM,EAAE,OAAO,YAAY,IAAI,MAAM,SAChC,KAAK,cAAc,EACnB,OAAO;AAAA,MACJ,QAAQ;AAAA,MACR,SAAS;AAAA,MACT,uBAAuB;AAAA,IAC3B,CAAC,EACA,GAAG,MAAM,OAAO;AAErB,QAAI,aAAa;AAEb,aAAO,MAAM,iCAAiC;AAAA,QAC1C;AAAA,QACA,OAAO,YAAY;AAAA,MACvB,CAAC;AAAA,IACL;AAEA,aAAS,IAAI,UAAU,WAAW;AAElC,WAAO;AAAA,MACH;AAAA,MACA;AAAA,MACA;AAAA,MACA,SAAS,MAAM;AAAA,MACf;AAAA,MACA;AAAA,IACJ;AAAA,EACJ,GA9NK;AA+NT,CAAC;",
  "names": []
}
