{
  "version": 3,
  "sources": ["../../../../../../trigger/generate-user-drafts.ts"],
  "sourcesContent": ["import { task, logger, metadata } from \"@trigger.dev/sdk\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport OpenAI from \"openai\";\n\n// ── Clients ──\nconst supabase = createClient(\n    process.env.SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\n// ── Email template types ──\nconst EMAIL_TEMPLATES = [\n    \"fundraising-appeal\",\n    \"deadline-urgency\",\n    \"welcome-series\",\n    \"thank-you-receipt\",\n    \"recurring-donor-upgrade\",\n    \"survey-engagement\",\n    \"story-driven-narrative\",\n    \"event-invitation\",\n] as const;\n\ntype EmailTemplate = (typeof EMAIL_TEMPLATES)[number];\n\ninterface BrandKit {\n    id: string;\n    kit_name: string;\n    brand_summary: string;\n    tone: string;\n    address: string;\n    copyright: string;\n    footer: string;\n    disclaimers: string;\n    colors: Record<string, string>;\n}\n\ninterface ResearchTopic {\n    id: string;\n    title: string;\n    summary: string;\n    content_snippet: string;\n    source_url: string;\n}\n\ninterface GeneratedDraft {\n    subject_line: string;\n    alt_subject_lines: string[];\n    preview_text: string;\n    body_html: string;\n    body_text: string;\n    template_used: string;\n}\n\n/**\n * Generate User Drafts — Per-User Email Writer\n *\n * Triggered by the Thursday Drop orchestrator.\n * Generates N email drafts based on the user's tier and brand kit.\n */\nexport const generateUserDrafts = task({\n    id: \"generate-user-drafts\",\n    machine: { preset: \"small-2x\" },\n    retry: {\n        maxAttempts: 3,\n        factor: 1.8,\n        minTimeoutInMs: 2000,\n        maxTimeoutInMs: 30_000,\n    },\n    run: async (payload: {\n        userId: string;\n        tier: number;\n        emailsToGenerate: number;\n        weekOf: string;\n    }) => {\n        const { userId, tier, emailsToGenerate, weekOf } = payload;\n\n        logger.info(`Generating ${emailsToGenerate} drafts for user ${userId}`, {\n            tier,\n            weekOf,\n        });\n\n        metadata\n            .set(\"userId\", userId)\n            .set(\"tier\", tier)\n            .set(\"emailsToGenerate\", emailsToGenerate)\n            .set(\"draftsCompleted\", 0)\n            .set(\"status\", \"loading_context\");\n\n        // ── 1. Load brand kit ──\n        const { data: brandKit, error: bkError } = await supabase\n            .from(\"brand_kits\")\n            .select(\"id, kit_name, brand_summary, tone, address, copyright, footer, disclaimers, colors\")\n            .eq(\"user_id\", userId)\n            .single();\n\n        if (bkError || !brandKit) {\n            logger.error(\"No brand kit found\", { userId, error: bkError?.message });\n            throw new Error(`Brand kit not found for user ${userId}`);\n        }\n\n        const bk = brandKit as BrandKit;\n\n        // ── 2. Load recent research topics ──\n        const { data: topics } = await supabase\n            .from(\"research_topics\")\n            .select(\"id, title, summary, content_snippet, source_url\")\n            .eq(\"user_id\", userId)\n            .eq(\"used_in_draft\", false)\n            .order(\"relevance_score\", { ascending: false })\n            .limit(5);\n\n        const researchTopics = (topics || []) as ResearchTopic[];\n\n        // ── 3. Load recent sent emails for variety ──\n        const { data: recentEmails } = await supabase\n            .from(\"email_drafts\")\n            .select(\"subject_line, draft_type\")\n            .eq(\"user_id\", userId)\n            .in(\"status\", [\"sent\", \"approved\", \"scheduled\"])\n            .order(\"created_at\", { ascending: false })\n            .limit(4);\n\n        // ── 4. Select templates (avoid repeating recent ones) ──\n        const selectedTemplates = selectTemplates(emailsToGenerate, recentEmails || []);\n\n        metadata.set(\"status\", \"generating_drafts\");\n\n        // ── 5. Generate each draft ──\n        const draftIds: string[] = [];\n\n        for (let i = 0; i < emailsToGenerate; i++) {\n            const template = selectedTemplates[i];\n            const topicsForThisDraft = researchTopics.slice(\n                i * 2,\n                Math.min((i + 1) * 2, researchTopics.length)\n            );\n\n            logger.info(`Generating draft ${i + 1}/${emailsToGenerate}`, { template });\n\n            try {\n                const draft = await generateDraft(bk, template, topicsForThisDraft, weekOf);\n\n                // Save to database\n                const { data: savedDraft, error: saveError } = await supabase\n                    .from(\"email_drafts\")\n                    .insert({\n                        user_id: userId,\n                        brand_kit_id: bk.id,\n                        week_of: weekOf,\n                        draft_type: \"weekly\",\n                        subject_line: draft.subject_line,\n                        preview_text: draft.preview_text,\n                        body_html: draft.body_html,\n                        body_text: draft.body_text,\n                        alt_subject_lines: draft.alt_subject_lines,\n                        status: \"pending_review\",\n                        ai_model: \"gpt-5.2-chat-latest\",\n                        research_topic_ids: topicsForThisDraft.map((t) => t.id),\n                    })\n                    .select(\"id\")\n                    .single();\n\n                if (saveError) {\n                    logger.error(`Failed to save draft ${i + 1}`, { error: saveError.message });\n                    continue;\n                }\n\n                draftIds.push(savedDraft.id);\n                metadata.increment(\"draftsCompleted\", 1);\n\n                // Mark research topics as used\n                if (topicsForThisDraft.length > 0) {\n                    await supabase\n                        .from(\"research_topics\")\n                        .update({ used_in_draft: true })\n                        .in(\n                            \"id\",\n                            topicsForThisDraft.map((t) => t.id)\n                        );\n                }\n\n                logger.info(`Draft ${i + 1} saved`, {\n                    draftId: savedDraft.id,\n                    subject: draft.subject_line,\n                    template,\n                });\n            } catch (err) {\n                logger.error(`Failed to generate draft ${i + 1}`, {\n                    error: (err as Error).message,\n                    template,\n                });\n            }\n        }\n\n        metadata.set(\"status\", \"completed\");\n\n        logger.info(`Completed generating drafts for user ${userId}`, {\n            total: emailsToGenerate,\n            saved: draftIds.length,\n        });\n\n        return {\n            userId,\n            weekOf,\n            draftsGenerated: draftIds.length,\n            draftIds,\n        };\n    },\n});\n\n// ── Helper: Select templates avoiding recent repeats ──\nfunction selectTemplates(\n    count: number,\n    recentEmails: Array<{ subject_line: string; draft_type: string }>\n): EmailTemplate[] {\n    // Shuffle available templates and pick `count`, avoiding what was recently sent\n    const shuffled = [...EMAIL_TEMPLATES].sort(() => Math.random() - 0.5);\n    return shuffled.slice(0, Math.min(count, shuffled.length));\n}\n\n// ── Helper: Generate a single draft via OpenAI ──\nasync function generateDraft(\n    brandKit: BrandKit,\n    template: EmailTemplate,\n    topics: ResearchTopic[],\n    weekOf: string\n): Promise<GeneratedDraft> {\n    const topicsContext =\n        topics.length > 0\n            ? topics\n                .map((t) => `- ${t.title}: ${t.summary || t.content_snippet}`)\n                .join(\"\\n\")\n            : \"No specific research topics available. Use general fundraising best practices.\";\n\n    const systemPrompt = `You are an expert fundraising email copywriter. Write emails that drive donations and engagement.\n\nBRAND CONTEXT:\n- Committee: ${brandKit.kit_name}\n- Mission: ${brandKit.brand_summary || \"Not specified\"}\n- Tone: ${brandKit.tone || \"Inspirational\"}\n- Disclaimers: ${brandKit.disclaimers || \"None\"}\n\nEMAIL FORMAT: ${template}\nWeek of: ${weekOf}\n\nCURRENT NEWS & TOPICS:\n${topicsContext}\n\nRULES:\n1. Open with a compelling hook — never \"Dear friend\" or \"I'm writing to...\"\n2. ONE clear call-to-action per email\n3. Match the brand's tone exactly\n4. Reference the committee name naturally\n5. 200-400 words for standard appeals, 100-200 for urgency\n6. End with a P.S. line\n7. Include 2-3 alternate subject lines for A/B testing\n8. Write both HTML (with basic formatting) and plain text versions\n\nReturn valid JSON with this exact structure:\n{\n  \"subject_line\": \"primary subject line\",\n  \"alt_subject_lines\": [\"alt 1\", \"alt 2\"],\n  \"preview_text\": \"40-90 char preview text\",\n  \"body_html\": \"<div>HTML email body</div>\",\n  \"body_text\": \"Plain text version\"\n}`;\n\n    const response = await openai.chat.completions.create({\n        model: \"gpt-5.2-chat-latest\",\n        messages: [\n            { role: \"system\", content: systemPrompt },\n            {\n                role: \"user\",\n                content: `Write a ${template} style fundraising email for ${brandKit.kit_name}. Return only valid JSON.`,\n            },\n        ],\n        temperature: 0.7,\n        max_tokens: 2000,\n        response_format: { type: \"json_object\" },\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) throw new Error(\"OpenAI returned empty response\");\n\n    const parsed = JSON.parse(content) as GeneratedDraft;\n    parsed.template_used = template;\n\n    return parsed;\n}\n"],
  "mappings": "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",
  "names": []
}
