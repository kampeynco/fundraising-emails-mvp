{
  "version": 3,
  "sources": ["../../../../../../trigger/generate-rapid-draft.ts"],
  "sourcesContent": ["import { task, logger, metadata } from \"@trigger.dev/sdk\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport OpenAI from \"openai\";\n\nconst supabase = createClient(\n    process.env.SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\nconst RAPID_TEMPLATES = [\n    \"breaking-news-response\",\n    \"opposition-attack-rebuttal\",\n    \"last-minute-match\",\n    \"deadline-surprise\",\n] as const;\n\ntype RapidTemplate = (typeof RAPID_TEMPLATES)[number];\n\n/**\n * Generate Rapid Response Draft — On-Demand Urgent Email\n *\n * Triggered manually when a breaking event requires an urgent fundraising email.\n * Uses the rapid-response-writer skill references for format.\n */\nexport const generateRapidDraft = task({\n    id: \"generate-rapid-draft\",\n    machine: { preset: \"small-2x\" },\n    retry: {\n        maxAttempts: 2,\n        factor: 1.5,\n        minTimeoutInMs: 1000,\n        maxTimeoutInMs: 15_000,\n    },\n    run: async (payload: {\n        userId: string;\n        topic: string;\n        urgency: \"critical\" | \"high\" | \"elevated\";\n        template: RapidTemplate;\n        sourceUrls?: string[];\n    }) => {\n        const { userId, topic, urgency, template, sourceUrls } = payload;\n\n        logger.info(\"⚡ Rapid response triggered\", { userId, topic, urgency, template });\n        metadata.set(\"status\", \"loading_context\").set(\"userId\", userId);\n\n        // 1. Verify user has rapid response enabled\n        const { data: subscription } = await supabase\n            .from(\"subscriptions\")\n            .select(\"tier, rapid_response\")\n            .eq(\"user_id\", userId)\n            .eq(\"status\", \"active\")\n            .single();\n\n        if (!subscription?.rapid_response) {\n            throw new Error(\"Rapid response not enabled for this user (requires tier 3+)\");\n        }\n\n        // 2. Load brand kit\n        const { data: brandKit, error: bkError } = await supabase\n            .from(\"brand_kits\")\n            .select(\"id, kit_name, brand_summary, tone, disclaimers, colors\")\n            .eq(\"user_id\", userId)\n            .single();\n\n        if (bkError || !brandKit) {\n            throw new Error(`Brand kit not found for user ${userId}`);\n        }\n\n        metadata.set(\"status\", \"generating_draft\");\n\n        // 3. Build context from source URLs (if provided)\n        const sourcesContext = sourceUrls?.length\n            ? sourceUrls.map((url) => `- Source: ${url}`).join(\"\\n\")\n            : \"No specific sources provided. Write based on the topic description.\";\n\n        // 4. Generate the draft\n        const systemPrompt = `You are an expert rapid-response fundraising email writer. Write URGENT emails that capitalize on breaking news moments.\n\nBRAND CONTEXT:\n- Committee: ${brandKit.kit_name}\n- Mission: ${brandKit.brand_summary || \"Not specified\"}\n- Tone: ${brandKit.tone || \"Inspirational\"} (dial urgency UP by 1 notch)\n\nFORMAT: ${template} (rapid response)\nTOPIC: ${topic}\nURGENCY: ${urgency}\n\nSOURCES:\n${sourcesContext}\n\nCRITICAL RULES:\n1. Keep it SHORT: 100-200 words maximum\n2. Lead with the news hook — NO preamble\n3. Write in present tense (\"Right now, as I type this...\")\n4. ONE donate CTA, prominently placed\n5. P.S. must reference the time-sensitive nature\n6. Subject line must convey urgency WITHOUT clickbait\n7. Include 2 alternate subject lines\n\nReturn valid JSON:\n{\n  \"subject_line\": \"primary subject\",\n  \"alt_subject_lines\": [\"alt 1\", \"alt 2\"],\n  \"preview_text\": \"40-90 chars\",\n  \"body_html\": \"<div>...</div>\",\n  \"body_text\": \"plain text\"\n}`;\n\n        const response = await openai.chat.completions.create({\n            model: \"gpt-5.2-chat-latest\",\n            messages: [\n                { role: \"system\", content: systemPrompt },\n                {\n                    role: \"user\",\n                    content: `Write a rapid response ${template} email about: ${topic}. Return only valid JSON.`,\n                },\n            ],\n            temperature: 0.6,\n            max_tokens: 1500,\n            response_format: { type: \"json_object\" },\n        });\n\n        const content = response.choices[0]?.message?.content;\n        if (!content) throw new Error(\"OpenAI returned empty response\");\n\n        const draft = JSON.parse(content);\n\n        // 5. Calculate week_of\n        const now = new Date();\n        const dayOfWeek = now.getUTCDay();\n        const monday = new Date(now);\n        monday.setUTCDate(now.getUTCDate() - ((dayOfWeek + 6) % 7));\n        const weekOf = monday.toISOString().split(\"T\")[0];\n\n        // 6. Save to database\n        const { data: savedDraft, error: saveError } = await supabase\n            .from(\"email_drafts\")\n            .insert({\n                user_id: userId,\n                brand_kit_id: brandKit.id,\n                week_of: weekOf,\n                draft_type: \"rapid_response\",\n                subject_line: draft.subject_line,\n                preview_text: draft.preview_text,\n                body_html: draft.body_html,\n                body_text: draft.body_text,\n                alt_subject_lines: draft.alt_subject_lines,\n                status: \"pending_review\",\n                ai_model: \"gpt-5.2-chat-latest\",\n            })\n            .select(\"id\")\n            .single();\n\n        if (saveError) {\n            logger.error(\"Failed to save rapid draft\", { error: saveError.message });\n            throw new Error(`Save failed: ${saveError.message}`);\n        }\n\n        metadata.set(\"status\", \"completed\");\n\n        logger.info(\"⚡ Rapid response draft saved\", {\n            draftId: savedDraft.id,\n            subject: draft.subject_line,\n            urgency,\n        });\n\n        return {\n            draftId: savedDraft.id,\n            subject: draft.subject_line,\n            urgency,\n            template,\n        };\n    },\n});\n"],
  "mappings": "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",
  "names": []
}
