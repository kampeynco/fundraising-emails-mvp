{
  "version": 3,
  "sources": ["../../../../../../trigger/thursday-drop.ts"],
  "sourcesContent": ["import { schedules, task, logger, metadata } from \"@trigger.dev/sdk\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport type { generateUserDrafts } from \"./generate-user-drafts\";\n\n// ‚îÄ‚îÄ Supabase client (service role for server-side access) ‚îÄ‚îÄ\nconst supabase = createClient(\n    process.env.SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\ninterface ActiveSubscription {\n    user_id: string;\n    tier: number;\n    emails_per_week: number;\n    rapid_response: boolean;\n}\n\n/**\n * Thursday Drop ‚Äî Weekly Email Draft Orchestrator\n *\n * Runs every Thursday at 6am CT (noon UTC).\n * Queries all active subscribers, then fans out\n * one `generate-user-drafts` child task per user.\n */\nexport const thursdayDrop = schedules.task({\n    id: \"thursday-drop\",\n    cron: { pattern: \"0 12 * * 4\", timezone: \"America/Chicago\" },\n    retry: { maxAttempts: 2 },\n    run: async (payload) => {\n        logger.info(\"üóìÔ∏è Thursday Drop starting\", {\n            scheduledTime: payload.timestamp,\n            timezone: payload.timezone,\n        });\n\n        // 1. Query all active subscriptions\n        const { data: subscriptions, error } = await supabase\n            .from(\"subscriptions\")\n            .select(\"user_id, tier, emails_per_week, rapid_response\")\n            .eq(\"status\", \"active\");\n\n        if (error) {\n            logger.error(\"Failed to fetch subscriptions\", { error: error.message });\n            throw new Error(`DB error: ${error.message}`);\n        }\n\n        if (!subscriptions || subscriptions.length === 0) {\n            logger.info(\"No active subscriptions found ‚Äî skipping\");\n            return { processed: 0 };\n        }\n\n        const subs = subscriptions as ActiveSubscription[];\n        logger.info(`Found ${subs.length} active subscribers`);\n\n        // 2. Track progress\n        metadata.set(\"totalUsers\", subs.length).set(\"processedUsers\", 0).set(\"status\", \"processing\");\n\n        // 3. Calculate week_of (Monday of this week)\n        const now = new Date();\n        const dayOfWeek = now.getUTCDay();\n        const monday = new Date(now);\n        monday.setUTCDate(now.getUTCDate() - ((dayOfWeek + 6) % 7));\n        const weekOf = monday.toISOString().split(\"T\")[0]; // YYYY-MM-DD\n\n        // 4. Fan out ‚Äî trigger one child task per user\n        const results: Array<{ userId: string; triggered: boolean }> = [];\n\n        for (const sub of subs) {\n            try {\n                const handle = await generateUserDraftsTask.trigger({\n                    userId: sub.user_id,\n                    tier: sub.tier,\n                    emailsToGenerate: sub.emails_per_week,\n                    weekOf,\n                });\n\n                results.push({ userId: sub.user_id, triggered: true });\n                logger.info(`Triggered drafts for user ${sub.user_id}`, {\n                    tier: sub.tier,\n                    emails: sub.emails_per_week,\n                    runId: handle.id,\n                });\n            } catch (err) {\n                results.push({ userId: sub.user_id, triggered: false });\n                logger.error(`Failed to trigger for user ${sub.user_id}`, {\n                    error: (err as Error).message,\n                });\n            }\n\n            metadata.increment(\"processedUsers\", 1);\n        }\n\n        const successCount = results.filter((r) => r.triggered).length;\n        metadata.set(\"status\", \"completed\");\n\n        logger.info(\"Thursday Drop complete\", {\n            total: subs.length,\n            succeeded: successCount,\n            failed: subs.length - successCount,\n        });\n\n        return {\n            processed: subs.length,\n            succeeded: successCount,\n            failed: subs.length - successCount,\n            weekOf,\n        };\n    },\n});\n\n// ‚îÄ‚îÄ Reference to child task (import type for type safety) ‚îÄ‚îÄ\nconst generateUserDraftsTask = {\n    trigger: async (payload: {\n        userId: string;\n        tier: number;\n        emailsToGenerate: number;\n        weekOf: string;\n    }) => {\n        const { tasks } = await import(\"@trigger.dev/sdk\");\n        return tasks.trigger<typeof generateUserDrafts>(\"generate-user-drafts\", payload);\n    },\n};\n"],
  "mappings": ";;;;;;;;;;;;;;;;AAAA;AAKA,IAAM,WAAW;AAAA,EACb,QAAQ,IAAI;AAAA,EACZ,QAAQ,IAAI;AAChB;AAgBO,IAAM,eAAe,kBAAU,KAAK;AAAA,EACvC,IAAI;AAAA,EACJ,MAAM,EAAE,SAAS,cAAc,UAAU,kBAAkB;AAAA,EAC3D,OAAO,EAAE,aAAa,EAAE;AAAA,EACxB,KAAK,8BAAO,YAAY;AACpB,WAAO,KAAK,8BAA8B;AAAA,MACtC,eAAe,QAAQ;AAAA,MACvB,UAAU,QAAQ;AAAA,IACtB,CAAC;AAGD,UAAM,EAAE,MAAM,eAAe,MAAM,IAAI,MAAM,SACxC,KAAK,eAAe,EACpB,OAAO,gDAAgD,EACvD,GAAG,UAAU,QAAQ;AAE1B,QAAI,OAAO;AACP,aAAO,MAAM,iCAAiC,EAAE,OAAO,MAAM,QAAQ,CAAC;AACtE,YAAM,IAAI,MAAM,aAAa,MAAM,OAAO,EAAE;AAAA,IAChD;AAEA,QAAI,CAAC,iBAAiB,cAAc,WAAW,GAAG;AAC9C,aAAO,KAAK,0CAA0C;AACtD,aAAO,EAAE,WAAW,EAAE;AAAA,IAC1B;AAEA,UAAM,OAAO;AACb,WAAO,KAAK,SAAS,KAAK,MAAM,qBAAqB;AAGrD,aAAS,IAAI,cAAc,KAAK,MAAM,EAAE,IAAI,kBAAkB,CAAC,EAAE,IAAI,UAAU,YAAY;AAG3F,UAAM,MAAM,oBAAI,KAAK;AACrB,UAAM,YAAY,IAAI,UAAU;AAChC,UAAM,SAAS,IAAI,KAAK,GAAG;AAC3B,WAAO,WAAW,IAAI,WAAW,KAAM,YAAY,KAAK,CAAE;AAC1D,UAAM,SAAS,OAAO,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC;AAGhD,UAAM,UAAyD,CAAC;AAEhE,eAAW,OAAO,MAAM;AACpB,UAAI;AACA,cAAM,SAAS,MAAM,uBAAuB,QAAQ;AAAA,UAChD,QAAQ,IAAI;AAAA,UACZ,MAAM,IAAI;AAAA,UACV,kBAAkB,IAAI;AAAA,UACtB;AAAA,QACJ,CAAC;AAED,gBAAQ,KAAK,EAAE,QAAQ,IAAI,SAAS,WAAW,KAAK,CAAC;AACrD,eAAO,KAAK,6BAA6B,IAAI,OAAO,IAAI;AAAA,UACpD,MAAM,IAAI;AAAA,UACV,QAAQ,IAAI;AAAA,UACZ,OAAO,OAAO;AAAA,QAClB,CAAC;AAAA,MACL,SAAS,KAAK;AACV,gBAAQ,KAAK,EAAE,QAAQ,IAAI,SAAS,WAAW,MAAM,CAAC;AACtD,eAAO,MAAM,8BAA8B,IAAI,OAAO,IAAI;AAAA,UACtD,OAAQ,IAAc;AAAA,QAC1B,CAAC;AAAA,MACL;AAEA,eAAS,UAAU,kBAAkB,CAAC;AAAA,IAC1C;AAEA,UAAM,eAAe,QAAQ,OAAO,CAAC,MAAM,EAAE,SAAS,EAAE;AACxD,aAAS,IAAI,UAAU,WAAW;AAElC,WAAO,KAAK,0BAA0B;AAAA,MAClC,OAAO,KAAK;AAAA,MACZ,WAAW;AAAA,MACX,QAAQ,KAAK,SAAS;AAAA,IAC1B,CAAC;AAED,WAAO;AAAA,MACH,WAAW,KAAK;AAAA,MAChB,WAAW;AAAA,MACX,QAAQ,KAAK,SAAS;AAAA,MACtB;AAAA,IACJ;AAAA,EACJ,GA9EK;AA+ET,CAAC;AAGD,IAAM,yBAAyB;AAAA,EAC3B,SAAS,8BAAO,YAKV;AACF,UAAM,EAAE,MAAM,IAAI,MAAM,OAAO,0BAAkB;AACjD,WAAO,MAAM,QAAmC,wBAAwB,OAAO;AAAA,EACnF,GARS;AASb;",
  "names": []
}
